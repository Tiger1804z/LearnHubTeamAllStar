generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}



//
// ENUMS = règles simples, évitent les "strings magiques"
//

enum UserRole {
  learner
  creator
  mentor
  admin
}

enum PathLevel {
  beginner
  intermediate
  advanced
}

enum EnrollmentStatus {
  active
  completed
  paused
}

enum QuestionType {
  mcq
  true_false
  short_answer
}

//
// USERS / PROFILS
//

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  role         UserRole @default(learner)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile Profile?

  // Learn
  enrollments     Enrollment[]
  lessonProgress  LessonProgress[]

  // Create
  createdPaths LearningPath[] @relation("UserCreatedPaths")

  // Quiz
  quizAttempts QuizAttempt[]

  // Community
  posts        Post[]
  groupMembers StudyGroupMember[]
}

model Profile {
  id     String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  bio         String?
  avatarUrl   String?

  xp Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// LEARNING CONTENT: Path -> Module -> Lesson
//

model LearningPath {
  id        String @id @default(cuid())
  creatorId String
  creator   User   @relation("UserCreatedPaths", fields: [creatorId], references: [id], onDelete: Cascade)

  title       String
  description String
  category    String
  level       PathLevel
  estMinutes  Int?

  isPublished Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  modules     Module[]
  enrollments Enrollment[]
  studyGroups StudyGroup[]
  threads     Thread[]
}

model Module {
  id     String @id @default(cuid())
  pathId String
  path   LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  title    String
  position Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lessons Lesson[]

  @@unique([pathId, position])
  @@index([pathId])
}

model Lesson {
  id       String @id @default(cuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title    String
  content  String
  position Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quiz     Quiz?
  progress LessonProgress[]

  @@unique([moduleId, position])
  @@index([moduleId])
}

//
// ENROLLMENT + PROGRESSION
//

model Enrollment {
  id String @id @default(cuid())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  pathId String
  path   LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  status      EnrollmentStatus @default(active)
  startedAt   DateTime         @default(now())
  completedAt DateTime?

  @@unique([userId, pathId])
  @@index([pathId])
}

model LessonProgress {
  id String @id @default(cuid())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  isCompleted Boolean @default(false)
  completedAt DateTime?

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId])
}

//
// QUIZ
//

model Quiz {
  id String @id @default(cuid())

  lessonId String @unique
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  title     String
  passScore Int @default(70)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions Question[]
  attempts  QuizAttempt[]
}

model Question {
  id String @id @default(cuid())

  quizId String
  quiz   Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  type     QuestionType
  prompt   String
  position Int

  expectedAnswer String?

  options Option[]
  answers QuizAnswer[]

  @@unique([quizId, position])
  @@index([quizId])
}

model Option {
  id String @id @default(cuid())

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text      String
  isCorrect Boolean @default(false)

  //  OPPOSITE RELATION pour QuizAnswer.selectedOption
  selectedBy QuizAnswer[] @relation("SelectedOptionAnswers")

  @@index([questionId])
}

model QuizAttempt {
  id String @id @default(cuid())

  quizId String
  quiz   Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  scorePct   Int
  passed     Boolean
  startedAt  DateTime @default(now())
  finishedAt DateTime?

  answers QuizAnswer[]

  @@index([quizId])
  @@index([userId])
}

model QuizAnswer {
  id String @id @default(cuid())

  attemptId String
  attempt   QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  selectedOptionId String?
  selectedOption   Option? @relation("SelectedOptionAnswers", fields: [selectedOptionId], references: [id])

  textAnswer String?

  @@index([attemptId])
  @@index([questionId])
}

//
// COMMUNITY
//

model Thread {
  id String @id @default(cuid())

  pathId String?
  path   LearningPath? @relation(fields: [pathId], references: [id], onDelete: Cascade)

  groupId String?
  group   StudyGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  title String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts Post[]

  @@index([pathId])
  @@index([groupId])
}

model Post {
  id String @id @default(cuid())

  threadId String
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  authorId String
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([threadId])
  @@index([authorId])
}

//
// STUDY GROUPS
//

model StudyGroup {
  id String @id @default(cuid())

  name        String
  description String?

  pathId String?
  path   LearningPath? @relation(fields: [pathId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members StudyGroupMember[]
  threads Thread[]

  @@index([pathId])
}

model StudyGroupMember {
  id String @id @default(cuid())

  groupId String
  group   StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  role     String   @default("member")
  joinedAt DateTime @default(now())

  @@unique([groupId, userId])
  @@index([userId])
}